<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Загрузка ресурсов: onload и onerror</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script defer src="../scripts.js"></script>
</head>

<body>
    <div class="contents">
        <h2><a href="#load">Загрузка ресурсов: onload и onerror</a></h2>
        <ul>
            <li><a href="#onload">Загрузка скриптов</a></li>
            <li><a href="#other">Другие ресурсы</a></li>
            <li><a href="#mistake">Ошибка в скрипте с другого источника</a></li>
            <li><a href="#total">Итого</a></li>
            <li><a href="#tasks">Задача</a></li>
        </ul>
    </div>
    <div class="topic" id="load">
        <h2><a href="https://learn.javascript.ru/onload-onerror">Загрузка ресурсов: onload и onerror</a></h2>
        <p>Есть два события:</p>
        <ol>
            <li><code>load</code> ресурс на страничку загрузился.</li>
            <li><code>error</code> в процессе загрузки произошла ошибка.</li>
        </ol>
        <p>Соотвественно есть два события на которые можно назначить обработчики <code>onload</code> и
            <code>onerror</code>.
        </p>
    </div>
    <div class="topic" id="onload">
        <h3>Загрузка скриптов</h3>
        <p>При добавлении скрипта:</p>
        <pre><code class="language-js">
let script = document.createElement('script');
script.src = "my.js";

document.head.append(script);        
    </code></pre>
        <p>Работать с тем что внутри можно по событию загрузки <code>script.onload=...</code></p>
        <div id="scriptonload">
            <h4>script.onload</h4>
            <p>Например:</p>
            <pre><input type="button" value="Тест кода" onclick="let script = document.createElement('script');

// мы можем загрузить любой скрипт с любого домена
script.src = 'https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.3.0/lodash.js'
document.head.append(script);

script.onload = function() {
  // в скрипте создаётся вспомогательная переменная с именем '_'
  alert(_.VERSION); // отображает версию библиотеки
};">
            <code class="language-js">
let script = document.createElement('script');

// мы можем загрузить любой скрипт с любого домена
script.src = "https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.3.0/lodash.js"
document.head.append(script);

script.onload = function() {
  // в скрипте создаётся вспомогательная переменная с именем "_"
  alert(_.VERSION); // отображает версию библиотеки
};            
        </code></pre>
        </div>
        <div id="scriptonerror">
            <h4>script.onerror</h4>
            <p>Обработчик <code>onerror</code>:</p>
            <pre><input type="button" value="Тест onerror" onclick="let script = document.createElement('script');
script.src = 'https://example.com/404.js'; // такого файла не существует
document.head.append(script);

script.onerror = function() {
  alert('Ошибка загрузки ' + this.src); // Ошибка загрузки https://example.com/404.js
};">
            <code class="language-js">
let script = document.createElement('script');
script.src = "https://example.com/404.js"; // такого файла не существует
document.head.append(script);

script.onerror = function() {
  alert("Ошибка загрузки " + this.src); // Ошибка загрузки https://example.com/404.js
};
        </code></pre>
            <p>Но понять какая ошибка произошла 400, 500 или что-то ещё не возможно.</p>
            <blockquote>
                <h4>Ошибки в скриптах отслеживаются через <code>window.onerror</code></h4>
                <code>obj.onerror</code> отслеживает только процесс загрузки.
            </blockquote>
        </div>
    </div>
    <div class="topic" id="other">
        <h3>Другие ресурсы</h3>
        <p>События <code>onload</code> и <code>onerror</code> касаются и других ресурсов у которых есть внешний
            <code>scr</code>. Например:
        </p>
        <script>
            function expl1() {
                let img = document.createElement('img');
                img.src = "https://js.cx/clipart/train.gif"; // (*)

                img.onload = function () {
                    alert(`Изображение загружено, размеры ${img.width}x${img.height}`);
                };

                img.onerror = function () {
                    alert("Ошибка во время загрузки изображения");
                };
            }
        </script>
        <pre><input type="button" value="Test load/error" onclick="expl1()"><code class="language-js">
let img = document.createElement('img');
img.src = "https://js.cx/clipart/train.gif"; // (*)

img.onload = function() {
  alert(`Изображение загружено, размеры ${img.width}x${img.height}`);
};

img.onerror = function() {
  alert("Ошибка во время загрузки изображения");
};                
            </code></pre>
        <p>Как видно загрузка идёт при создании элемента <code>img</code>. Однако есть некоторые особенности:</p>
        <ul>
            <li>Большинство ресурсов начинают загружаться после их добавления в документ. За исключением тега
                <code>&lt;img></code>. Изображения начинают загружаться, когда получают <code>src (*)</code>.
            </li>
            <li>Для <code>&lt;iframe></code> событие <code>load</code> срабатывает по окончании загрузки как в случае
                успеха, так и в случае ошибки.</li>
        </ul>
        <p>Такое поведение закрепилось у этих элементов исторически.</p>
    </div>
    <div class="topic" id="mistake">
        <h3>Ошибка в скрипте с другого источника</h3>
        <p>Скрипты с одного сайта не могут иметь доступ к содержимому другого сайта. По большей части.</p>
        <strong>Чтобы разрешить кросс-доменный доступ, нам нужно поставить тегу
            <code>&lt;script></code> атрибут crossorigin, и, кроме того, удалённый сервер должен поставить специальные
            заголовки.</strong>
        <p>Три уровня кросс-доменного доступа:</p>
        <ol>
            <li>Атрибут <code>crossorigin</code> отсутствует – доступ запрещён.</li>
            <li><code>crossorigin="anonymous"</code> – доступ разрешён, если сервер отвечает с заголовком
                <code>Access-Control-Allow-Origin</code> со значениями * или наш домен. Браузер не отправляет
                авторизационную информацию и куки на удалённый сервер.
            </li>
            <li><code>crossorigin="use-credentials"</code> – доступ разрешён, если сервер отвечает с заголовками
                <code>Access-Control-Allow-Origin</code> со значением наш домен и
                <code>Access-Control-Allow-Credentials: true</code>. Браузер отправляет авторизационную информацию и
                куки на удалённый сервер.
            </li>
        </ol>
    </div>
    <div class="topic" id="total">
        <h3>Итого</h3>
        <p>Изображения, скрипты, внешние стили и другие ресурсы поддерживают события <code>load</code> и
            <code>error</code> для отслеживания загрузок или ошибок загрузки:
        </p>
        <ul>
            <li><code>load</code> срабатывает при успешной загрузке,</li>
            <li><code>error</code> срабатывает при ошибке загрузки.</li>
        </ul>
        <p>Единственное исключение это то, что <code>&lt;iframe&gt;</code>  даёт событие load и на успешную загрузку и на неудачу.</p>
        <p>Так же есть событие <code>readystatechange </code>, но оно редко используется по мнению автора.</p>
    </div>
</body>

</html>