<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Куки, document.cookie</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script defer src="../scripts.js"></script>
</head>

<body>
    <div class="contents">
        <h2><a href="#cook">Куки, document.cookie</a></h2>
        <ul>
            <li><a href="#read">Чтение из document.cookie</a></li>
            <li><a href="#write">Запись в document.cookie</a></li>
            <li><a href="#path">path</a></li>
            <li><a href="#domain">domain</a></li>
            <li><a href="#expires">expires, max-age</a></li>
            <li><a href="#secure">secure</a></li>
            <li><a href="#samesite">samesite</a></li>
            <li><a href="#httpOnly">httpOnly</a></li>
            <li><a href="#appendix1">Приложение: Функции для работы с куки</a></li>
            <li><a href="#appendix2">Приложение: Сторонние куки</a></li>
            <li><a href="#GDPR">Приложение: GDPR</a></li>
            <li><a href="#total">Итого</a></li>
        </ul>
    </div>
    <div class="topic" id="cook">
        <h2><a href="https://learn.javascript.ru/cookie">Куки, document.cookie</a></h2>
        <p>Куки это небольшие строки данных которые храняться в браузере, длинной не более 4 кб. Являются частью
            HTTP-протокола определенного в стандарте.</p>
        <p>Устаналиваются сервером при помощи заголовка <code>Set-Cookie</code>. Потом браузер будет автоматически
            сообщать серверу какие у него куки заголовком <code>Cookie</code>.</p>
        <p>Наиболее распорстранённый сценарий это аунтефикация, в том числе и незаметная для пользователя:</p>
        <ol>
            <li>При входе на сайт сервер отсылает в ответ HTTP-заголовок Set-Cookie для того, чтобы установить куки со
                специальным уникальным идентификатором сессии («session identifier»).</li>
            <li>Во время следующего запроса к этому же домену браузер посылает на сервер HTTP-заголовок Cookie.</li>
            <li>Таким образом, сервер понимает, кто сделал запрос. </li>
        </ol>
        <p>Из скрипта на странице есть возможность получить доступ к свойству <code>document.cookie</code>.</p>
    </div>
    <div class="topic" id="read">
        <h3>Чтение из document.cookie</h3>
        <p>Чтобы прочитать куки сервера надо вызвать: <input type="button" value="Тест кук"
                onclick="alert( document.cookie );"></p>
        <pre><code class="language-js">alert( document.cookie ); // cookie1=value1; cookie2=value2;...</code></pre>
        <p>Естественно с локального документа не покажет ничего. Потому что ничего не установлено изначально.</p>
    </div>
    <div class="topic" id="write">
        <h3>Запись в document.cookie</h3>
        <p><code>document.cookie</code> - это ассессор, доступ к нему обрабатывается особым образом, свойство не
            обнуляется, а обновляется. Например:</p>
        <input type="button" value="Tест добавления кук" onclick="document.cookie = 'user=John'; // обновляем только куки с именем 'user'
alert(document.cookie); // показываем все куки">
        <pre><code class="language-js">
document.cookie = "user=John"; // обновляем только куки с именем 'user'
alert(document.cookie); // показываем все куки                
            </code></pre>
        <p>Добавить куки можно только при просмотре в локальном сервере, открытый с диска документ не позволяет
            установить куки. Соотвественно если какие-то куки были до этого, они перезаписаны не будут, а произойдёт
            добавление кук.</p>
        <p>Технически данные могут быть любыми, но лучше использовать ф-цию <code>encodeURIComponent</code> для
            правильной установки кук:</p>
        <pre><code class="language-js">
// специальные символы (пробелы), требуется кодирование
let name = "my name";
let value = "John Smith"

// кодирует в my%20name=John%20Smith
document.cookie = encodeURIComponent(name) + '=' + encodeURIComponent(value);

alert(document.cookie); // ...; my%20name=John%20Smith                
            </code></pre>
        <p>В <a href="#appendix1">топике ниже</a> автор даёт нормальные ф-ции для работы с куками.</p>
        <blockquote>
            <h4>Ограничения</h4>
            <ul>
                <li>После encodeURIComponent пара name=value не должна занимать более 4Кб. Таким образом, мы не можем
                    хранить в куки большие данные.</li>
                <li>Общее количество куки на один домен ограничивается примерно 20+. Точное ограничение зависит от
                    конкретного браузера. </li>
            </ul>
        </blockquote>
    </div>
    <div class="topic" id="path">
        <h3>path</h3>
        <p><code>path=/somepath</code></p>
        <p>Значения будут доступны на путях <code>somepath</code>. То есть на страницах <code>/somepath</code>,
            <code>/somepath/someelse</code>, но не на путях <code>/difpath</code>.
        </p>
        <p>Установка <code>path=/</code> обеспечивает доступность кук по всему сайту.</p>
    </div>
    <div class="topic" id="domain">
        <h3>domain</h3>
        <p><code>domain=site.com</code> - подразумевается, что установить куки для другого домена не удасться. Настройка
            нужна для того, чтобы кука была доступа и с site.com и с forum.site.com. Работает так:</p>
        <pre><code class="language-js">
// находясь на странице site.com
// сделаем куки доступным для всех поддоменов *.site.com:
document.cookie = "user=John; domain=site.com"

// позже

// на forum.site.com
alert(document.cookie); // есть куки user=John                
            </code></pre>
        <p>Tак же работает запись .site.com по историческим причинам, для старых браузеров обозначает поддомены.</p>
    </div>
    <div class="topic" id="expires">
        <h3>expires, max-age</h3>
        <p>Куки без этих параметров являются сессионными и удаляются при закрытии браузера. Для того, чтобы избежать
            этого надо установить значения <code>expires</code> или <code>max-age</code>.</p>
        <p><code>expires=Tue, 19 Jan 2038 03:14:07 GMT</code> по истечении этой даты браузер удалит автоматически куку.
            Кука должна быть в зоне GMT, в целом можно устанавливать так:</p>
        <pre><code class="language-js">
// +1 день от текущей даты
let date = new Date(Date.now() + 86400e3);
date = date.toUTCString();
document.cookie = "user=John; expires=" + date;            
        </code></pre>
        <p>Если дата будет меньше текущей, кука удалится.</p>
        <p>В качестве альтернативы может выступать <code>max-age=3600</code>:</p>
        <pre><code class="language-js">
// куки будет удалено через 1 час
document.cookie = "user=John; max-age=3600";

// удалим куки (срок действия истекает прямо сейчас)
document.cookie = "user=John; max-age=0";            
        </code></pre>
    </div>
    <div class="topic" id="secure">
        <h3>secure</h3>
        <p><code>secure</code> - эту куку следует передавать только по шифрованному соединению:</p>
        <pre><code class="language-js">
// предполагается, что сейчас мы на https://
// установим опцию secure для куки (куки доступно только через HTTPS)
document.cookie = "user=John; secure";            
        </code></pre>
    </div>
    <div class="topic" id="samesite">
        <h3>samesite</h3>
        <p>Настройка безопасности, читал пару раз топик перед конспектированием не особо понимаю, как это происходит.
        </p>
        <h4>Атака XSRF</h4>
        <p>Скрытое поле формы для предотвращения этой атаки. Опять же не понимаю как это работает, надо смотреть код.
        </p>
        <h3>Настройка samesite</h3>
        <p>Есть два возможных значения:</p>
        <ul>
            <li><code>samesite=strict</code> <strong>по умолчанию то бишь <code>samesite</code> без значения.</strong>

                <br>При этой настройке куки не будут отправляться если отправка идёт с другого сайта. (объяснение
                дипсика)
            </li>
            <li><code>samesite=lax</code> Пишет что куки отправляются только на безопасных гёт-запросах, а вот на
                POST-запросах это работать не будет.</li>
        </ul>
        <p>Все старые сайты до 2017 года имеют настройку <code>None</code> и потому уязвимы.</p>
    </div>
    <div class="topic" id="httpOnly">
        <h3>httpOnly</h3>
        <p>Настройка веб-сервера <code>httpOnly</code> позволяет только веб-серверу изменять куки из
            <code>document.cookie</code> ни изменить ни установить будет нельзя.
        </p>
    </div>
    <div class="topic" id="appendix1">
        <h3>Приложение: Функции для работы с куки</h3>
        <p>Стандартных Функций для работы с куками нет. Но есть библиотеки для ноды, автор же предлагает из браузера
            использовать следующие Функции:</p>
        <div id="getCookie">
            <h4>getCookie(name)</h4>
            <pre><code class="language-js">
// возвращает куки с указанным name,
// или undefined, если ничего не найдено
function getCookie(name) {
  let matches = document.cookie.match(new RegExp(
    "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
  ));
  return matches ? decodeURIComponent(matches[1]) : undefined;
}                
            </code></pre>
        </div>
        <div id="setCookie">
            <h4>setCookie(name, value, options)</h4>
            <pre><code class="language-js">
function setCookie(name, value, options = {}) {

  options = {
    path: '/',
    // при необходимости добавьте другие значения по умолчанию
    ...options
  };

  if (options.expires instanceof Date) {
    options.expires = options.expires.toUTCString();
  }

  let updatedCookie = encodeURIComponent(name) + "=" + encodeURIComponent(value);

  for (let optionKey in options) {
    updatedCookie += "; " + optionKey;
    let optionValue = options[optionKey];
    if (optionValue !== true) {
      updatedCookie += "=" + optionValue;
    }
  }

  document.cookie = updatedCookie;
}

// Пример использования:
setCookie('user', 'John', {secure: true, 'max-age': 3600});                
            </code></pre>
        </div>
        <div id="deleteCookie">
            <h4>deleteCookie(name)</h4>
            <p>Удаление кук путём их просрочки:</p>
            <pre><code class="language-js">
function deleteCookie(name) {
  setCookie(name, "", {
    'max-age': -1
  })
}                
            </code></pre>
        </div>
    </div>

</body>

</html>