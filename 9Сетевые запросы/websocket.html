<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script defer src="../scripts.js"></script>
</head>

<body>
    <div class="contents">
        <h2><a href="#websockets">WebSocket</a></h2>
        <ul>
            <li><a href="#simple">Простой пример</a></li>
            <li><a href="#open">Открытие веб-сокета</a></li>
            <li><a href="#send">Передача данных</a></li>
            <li><a href="#reduce">Ограничение скорости</a></li>
            <li><a href="#close">Закрытие подключения</a></li>
            <li><a href="#state">Состояние соединения</a></li>
            <li><a href="#expmlechat">Пример чата</a></li>
            <li><a href="#total">Итого</a></li>
        </ul>
    </div>

    <div class="topic" id="websockets">
        <h2><a href="https://learn.javascript.ru/websocket">WebSocket</a></h2>
        <p>Постоянное соединение между браузером и сервером используется для сервисом которые используют обмен
            реалтаймовыми данными.</p>
    </div>
    <div class="topic" id="simple">
        <h3>Простой пример</h3>
        <p>Создание объекта соединения:</p>
        <pre><code class="lang">
let socket = new WebSocket("ws://javascript.info");            
        </code></pre>
        <p>Где <code>ws</code> - это не шифрованный протокол, а <code>wss</code> - шифрованный протокол, который более
            предпочителен для использования.
        </p>
        <p>После создания объекта у него есть 4 события которые необходимо обрабатывать:</p>
        <ol>
            <li><code>open</code> – соединение установлено,</li>
            <li><code>message</code> – получены данные,</li>
            <li><code>error</code> – ошибка,</li>
            <li><code>close</code> – соединение закрыто. </li>
        </ol>
        <p>Для отправки данных есть метод: <code>obj.send(data)</code>. Например:</p>
        <pre><input type="button" value="Тест веб-сокета" onclick="expl1()"><code class="language-js">
let socket = new WebSocket("wss://javascript.info/article/websocket/demo/hello");

socket.onopen = function(e) {
  alert("[open] Соединение установлено");
  alert("Отправляем данные на сервер");
  socket.send("Меня зовут Джон");
};

socket.onmessage = function(event) {
  alert(`[message] Данные получены с сервера: ${event.data}`);
};

socket.onclose = function(event) {
  if (event.wasClean) {
    alert(`[close] Соединение закрыто чисто, код=${event.code} причина=${event.reason}`);
  } else {
    // например, сервер убил процесс или сеть недоступна
    // обычно в этом случае event.code 1006
    alert('[close] Соединение прервано');
  }
};

socket.onerror = function(error) {
  alert(`[error]`);
};            
        </code></pre>
        <script>
            function expl1(params) {
                let socket = new WebSocket("wss://javascript.info/article/websocket/demo/hello");

                socket.onopen = function (e) {
                    alert("[open] Соединение установлено");
                    alert("Отправляем данные на сервер");
                    socket.send("Меня зовут Джон");
                };

                socket.onmessage = function (event) {
                    alert(`[message] Данные получены с сервера: ${event.data}`);
                };

                socket.onclose = function (event) {
                    if (event.wasClean) {
                        alert(`[close] Соединение закрыто чисто, код=${event.code} причина=${event.reason}`);
                    } else {
                        // например, сервер убил процесс или сеть недоступна
                        // обычно в этом случае event.code 1006
                        alert('[close] Соединение прервано');
                    }
                };

                socket.onerror = function (error) {
                    alert(`[error]`);
                };
            }
        </script>
        <p>За ответ на этот запрос отвечает <a
                href="https://learn.javascript.ru/article/websocket/demo/server.js">server.js</a>.</p>
    </div>
    <div class="topic" id="open">
        <h3>Открытие веб-сокета</h3>
        <p>В топике идёт обсуждение как происходит обмен данными на уровне заголовков. Из интересно-полезного рассказ о
            <a href="https://learn.javascript.ru/websocket#rasshireniya-i-podprotokoly">подпротоколах</a>.
        </p>
    </div>
    <div class="topic" id="send">
        <h3>Передача данных</h3>
        <p>Данные могут быть:</p>
        <ul>
            <li>Тестовые фреймы.</li>
            <li>Бинарные фреймы.</li>
            <li>ping-pong фреймы.</li>
            <li>Служебные фреймы которые меняют состоняние соединения.</li>
        </ul>
        <p>Методы <code>.send(body)</code> принимает body, как бинарные данные или как строку. При получении строк они
            распознаются автоматически, а для бинарных данных есть метод <code>socket.binaryType</code> который
            позволяет задать данные как blob или ArrayBuffer. По умолчанию стоит blob. Например:</p>
        <pre><code class="language-js">
socket.binaryType = "arraybuffer";
socket.onmessage = (event) => {
  // event.data является строкой (если текст) или arraybuffer (если двоичные данные)
};                
            </code></pre>
    </div>
    <div class="topic" id="reduce">
        <h3>Ограничение скорости</h3>
        <p>Ограничение скорости не в байтах, а в проверке наличия данных для отправки при помощи свойства
            <code>socket.bufferedAmount</code> и если буфер пуст - отправка ещё. Например:
        </p>
        <pre><code class="language-js">
// каждые 100мс проверить сокет и отправить больше данных,
// только если все текущие отосланы
setInterval(() => {
  if (socket.bufferedAmount == 0) {
    socket.send(moreData());
  }
}, 100);                
            </code></pre>
    </div>
    <div class="topic" id="close">
        <h3>Закрытие подключения</h3>
        <pre><code class="language-js">
socket.close([code], [reason]);            
        </code></pre>
        <p>Где <code>code</code>- специальный WebSocket-код закрытия (не обязателен) и <code>reason</code> строка с
            описанием причнины тоже не обязательна.</p>
        <p>Коды могут быть:</p>
        <ul>
            <li>1000 – по умолчанию, нормальное закрытие,</li>
            <li>1006 – невозможно установить такой код вручную, указывает, что соединение было потеряно (нет фрейма
                закрытия).</li>
            <li>1001 – сторона отключилась, например сервер выключен или пользователь покинул страницу,</li>
            <li>1009 – сообщение слишком большое для обработки,</li>
            <li>1011 – непредвиденная ошибка на сервере,</li>
            <li>…и так далее </li>
        </ul>
        <p>Как видно ряд кодов невозможно установить вручную, менее 1000 коды тоже зарезервированы. Например:</p>
        <pre><code class="language-js">
// закрывающая сторона:
socket.close(1000, "работа закончена");

// другая сторона:
socket.onclose = event => {
  // event.code === 1000
  // event.reason === "работа закончена"
  // event.wasClean === true (закрыто чисто)
};            
        </code></pre>
    </div>
    <div class="topic" id="state">
        <h3>Состояние соединения</h3>
        <p>Для получения состояния соединения существует свойство <code>socket.readyState</code> получаемые значения
            обозначают:</p>
        <ul>
            <li>0 – «CONNECTING»: соединение ещё не установлено,</li>
            <li>1 – «OPEN»: обмен данными,</li>
            <li>2 – «CLOSING»: соединение закрывается,</li>
            <li>3 – «CLOSED»: соединение закрыто. </li>
        </ul>
    </div>
    <div class="topic" id="expmlechat">
        <h3><a href="https://learn.javascript.ru/websocket#primer-chata">Пример чата</a></h3>
        <p>Перепечатывать не буду, оно плюс-минус понятно как.</p>
    </div>
    <div class="topic" id="total">
        <h3>Итого</h3>
        <p>WebSocket – это современный способ иметь постоянное соединение между браузером и сервером, где нет
            ограничений на кросс-доменные запросы, хорошо поддеживается браузерами, можно отправлять как строки, так и
            бинарные данные.</p>
        <p>Апи прост, всего пара методов:</p>
        <ul>
            <li><code>socket.send(data)</code>,</li>
            <li><code>socket.close([code], [reason])</code></li>
        </ul>
        <p>А так же несколько событий, которые необходимо слушать:</p>
        <ul>
<li>open,</li>
<li>message,</li>
<li>error,</li>
<li>close.            </li>
        </ul>
        <p>Методы аунтефикации, переподключения при обрыве и прочая - реализуются поверх WebSocket.</p>
    </div>
</body>

</html>