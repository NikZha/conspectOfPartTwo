<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IndexedDB</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script defer src="../scripts.js"></script>
</head>

<body>
    <div class="contents">
        <h2><a href="#indexeddb">IndexedDB</a></h2>
        <ul>
            <li><a href="#open">Открыть базу данных</a></li>
            <li><a href="#wharehouse">Хранилище объектов</a></li>
            <li><a href="#transact">Транзакции</a></li>
            <li><a href="#auto">Автоматическая фиксация транзакций</a></li>
            <li><a href="#errors">Обработка ошибок</a></li>
            <li><a href="#keys">Поиск по ключам</a></li>
            <li><a href="#index">Поиск по индексированному полю</a></li>
            <li><a href="#delete">Удаление из хранилища</a></li>
            <li><a href="#cursors">Курсоры</a></li>
            <li><a href="#include">Обёртка для промисов</a></li>
            <li><a href="#total">Итого</a></li>
        </ul>
    </div>

    <div class="topic" id="indexeddb">
        <h2><a href="https://learn.javascript.ru/indexeddb">IndexedDB</a></h2>
        <p>IndexedDB – это встроенная база данных, которая:</p>
        <ul>
            <li>Хранит практически любые значения по ключам, несколько типов ключей</li>
            <li>Поддерживает транзакции для надёжности.</li>
            <li>Поддерживает запросы в диапазоне ключей и индексы.</li>
            <li>Позволяет хранить больше данных, чем <code>localStorage</code>. </li>
        </ul>
        <p>Работает на событиях, но есть обёртки на промисах например https://github.com/jakearchibald/idb</p>
    </div>

    <div class="topic" id="open">
        <h3>Открыть базу данных</h3>
        <pre><code class="language-js">
let openRequest = indexedDB.open(name, version);            
        </code></pre>
        <p>Где:</p>
        <ul>
            <li><code>name</code> – название базы данных, строка.</li>
            <li><code>version</code> – версия базы данных, положительное целое число, по умолчанию 1 (объясняется ниже).
            </li>
        </ul>
        <p>Доступ к бд осуществляется по политике одного источка. После создания бд необходимо назначить обработчики
            событий для объекта <code>openRequest</code>:</p>
        <ul>
            <li><code>success</code>: база данных готова к работе, готов «объект базы данных» openRequest.result, его
                следует использовать для дальнейших вызовов.</li>
            <li><code>error</code>: не удалось открыть базу данных.</li>
            <li><code>upgradeneeded</code>: база открыта, но её схема устарела (см. ниже). </li>
        </ul>
        <p><strong>IndexedDB имеет встроенный механизм «версионирования схемы», который отсутствует в серверных базах
                данных.</strong></p>
        <p>База данных работает в браузере и и прямого доступа к данным нет, однако когда база данных публикуется и
            версия меньше чем текущая то может потребоваться обновить БД и сработает специальное событие
            <code>upgradeneeded</code>.
        </p>
        <pre><code class="language-js">
let openRequest = indexedDB.open("store", 1);

openRequest.onupgradeneeded = function() {
  // срабатывает, если на клиенте нет базы данных
  // ...выполнить инициализацию...
};

openRequest.onerror = function() {
  console.error("Error", openRequest.error);
};

openRequest.onsuccess = function() {
  let db = openRequest.result;
  // продолжить работу с базой данных, используя объект db
};                
            </code></pre>
        <p>Допустим дальше мы инициализируем 2 версию:</p>
            <pre><code class="language-js">
let openRequest = indexedDB.open("store", 2);

openRequest.onupgradeneeded = function(event) {
  // версия существующей базы данных меньше 2 (или база данных не существует)
  let db = openRequest.result;
  switch(event.oldVersion) { // существующая (старая) версия базы данных
    case 0:
      // версия 0 означает, что на клиенте нет базы данных
      // выполнить инициализацию
    case 1:
      // на клиенте версия базы данных 1
      // обновить
  }
};                
            </code></pre>
            <p>Удаление БД</p>
            <pre><code class="language-js">
let deleteRequest = indexedDB.deleteDatabase(name)
// deleteRequest.onsuccess/onerror отслеживает результат                
            </code></pre>
    </div>









</body>

</html>