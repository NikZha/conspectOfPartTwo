<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fetch: запросы на другие сайты</title>
    <link rel="stylesheet" href="../styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>hljs.highlightAll();</script>
    <script defer src="../scripts.js"></script>
</head>

<body>
    <div class="contents">
        <h2><a href="#crossorigin">Fetch: запросы на другие сайты</a></h2>
        <ul>
            <li><a href="#forwhat">Зачем нужен CORS? Экскурс в историю</a></li>
            <li><a href="#simple">Простые запросы</a></li>
            <li><a href="#cors">CORS для простых запросов</a></li>
            <li><a href="#headers">Заголовки ответа</a></li>
            <li><a href="#notsimple">«Непростые» запросы</a></li>
            <li><a href="#autorise">Авторизационные данные</a></li>
            <li><a href="#total">Итого</a></li>
            <li><a href="#tasks">Задачи</a></li>
        </ul>
    </div>
    <div class="topic" id="crossorigin">
        <h2><a href="https://learn.javascript.ru/fetch-crossorigin">Fetch: запросы на другие сайты</a></h2>
        <pre><code class="lang">
            //НЕ СРАБОТАЕТ ПРИМЕРНО НИКОГДА
            let url = 'https://ya.ru'
            async function expl1() {
                let response = await fetch(url, {
                    method: 'GET', headers: [
                        ['Host', url],
                        ['Origin', 'localhost']
                    ]
                })
                let result = await response.text()
                console.dir(result)
            }            
        </code></pre>
        <script>
            let url = 'https://ya.ru'
            async function expl1() {
                let response = await fetch(url, {
                    method: 'GET', headers: [
                        ['Host', url],
                        ['Origin', 'localhost']
                    ]
                })
                let result = await response.text()
                console.dir(result)
            }
        </script>
        <input type="button" value="Не сработает подробности в консоли" onclick="expl1()">
        <p>На 99,9% сайтов не работают запросы в браузере, так как срабатывает политика браузера
            «CORS»: Cross-Origin Resource Sharing («совместное использование ресурсов между разными источниками»).
            Отключить можно, но это около опасно. Любые манипуляции с скрапингом интернет-ресурсов требуют написания
            бэка.
            Дипсик говорил, что есть прокси с которых можно якобы качать, но и они не работают могут не работать.
        </p>
        <p><code>fetch</code> будет использовать политику одного источника или если у ресурса установлен специальный
            заголовок, чего нет у 99,9% сайтов.</p>
        <p>Таким образом пока видится использование <code>fetch</code> лишь для манипуляций на файловой системе и тут
            скорее всего вылезут какие-нибудь подводные камни.</p>
    </div>
    <div class="topic" id="forwhat">
        <h3>Зачем нужен CORS? Экскурс в историю</h3>
        <p>Cors это ослабление политики доступа с одного ресурса на другой, ранее это было в принципе не возможно.</p>
        <div id="form">
            <h4>Использование форм</h4>
            <p>Из ситуации выходили кто как может, например при помощи <code>iframe</code>:</p>
            <pre><code class="language-js">

        &lt;!-- цель формы -->
&lt;iframe name="iframe">&lt;/iframe>

&lt;!-- форма могла быть динамически сгенерирована и отправлена с помощью JavaScript -->
        &lt;form target="iframe" method="POST" action="http://narcat.narod.ru" id="form1">
            &lt;button type="submit" form="form1" value="Submit">Submit&lt;/button>
        &lt;/form>                
            </code></pre>

            <!-- цель формы -->
            <iframe name="iframe"></iframe>

            <!-- форма могла быть динамически сгенерирована и отправлена с помощью JavaScript -->
            <form target="iframe" method="POST" action="http://narcat.narod.ru" id="form1">
                <button type="submit" form="form1" value="Submit">Submit</button>
            </form>
            <p>Как видно и этот метод к настоящему моменту не сработает из-за политики одного источника и запрещения в
                заголовках размещать старницу во фрейме.</p>
        </div>
        <div id="use">
            <h4>Использование скриптов</h4>
            <p>Идея в использовании <code>script.src</code>:</p>
            <pre><code class="language-js">
// 1. Объявить функцию для обработки погодных данных
function gotWeather({ temperature, humidity }) {
  alert(`температура: ${temperature}, влажность: ${humidity}`);
}
let script = document.createElement('script');
script.src = `http://another.com/weather.json?callback=gotWeather`;
document.body.append(script);
// Ожидаемый ответ от сервера выглядит так:
gotWeather({
  temperature: 25,
  humidity: 78
});                
            </code></pre>
            <p>В целом выглядит как костыль.</p>
        </div>
    </div>
    <div class="topic" id="simple">
        <h3>Простые запросы</h3>
        <p>Запрос на другой источник делятся на:</p>
        <ol>
            <li>Простые.</li>
            <li>Все остальные.</li>
        </ol>
        <p>Простой запрос - это:</p>
        <ol>
            <li>Простой метод: GET, POST или HEAD</li>
            <li>Простые заголовки – разрешены только:</li>
            <ul>
                <li>Accept,</li>
                <li>Accept-Language,</li>
                <li>Content-Language,</li>
                <li>Content-Type со значением application/x-www-form-urlencoded, multipart/form-data или text/plain.
                </li>
            </ul>
        </ol>
        <p>Все остальное простым запросом не является.</p>
        <p><strong>Принципиальное отличие между ними состоит в том, что «простой запрос» может быть сделан через
                <code>&lt;form></code> или <code>&lt;script></code>, без каких-то специальных методов.</strong></p>
        <p>Для отправления сложного запроса, можно сделать предзапрос, чтобы выяснить готов ли сервер принять сложный
            запрос.</p>
    </div>
    <div class="topic" id="cors">
        <h3><a href="https://learn.javascript.ru/fetch-crossorigin#cors-dlya-prostyh-zaprosov">CORS для простых
                запросов</a></h3>
        <p>Ну в целом ситуция простая <code>fetch()</code> посылает простой запрос, и если в ответе браузера есть
            заголовок <code>Access-Control-Allow-Origin:</code> который позволяет сделать простой запрос с этого хоста
            то браузер предоставляте ответ, если нет, то ответ сервера блокируется.</p>
        <p>Излишние подробности, текстовые диаграммы, заголовки запроса-ответа, все по ссылке, особо смысла это в
            конспекте мусолить нет.</p>
    </div>
    <div class="topic" id="headers">
        <h3><a href="https://learn.javascript.ru/fetch-crossorigin#zagolovki-otveta">Заголовки ответа</a></h3>
        <p>По умолчанию при запросе к другому источнику JavaScript может получить доступ только к так называемым
            «простым» заголовкам ответа:</p>
        <ul>
            <li><code>Cache-Control</code></li>
            <li><code>Content-Language</code></li>
            <li><code>Content-Length</code></li>
            <li><code>Content-Type</code></li>
            <li><code>Expires</code></li>
            <li><code>Last-Modified</code></li>
            <li><code>Pragma            </code></li>
        </ul>
        <p>Чтобы разрешить JavaScript доступ к любому другому заголовку ответа, сервер должен указать заголовок
            Access-Control-Expose-Headers</p>
    </div>


</body>

</html>